<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="æœ¬åœ°æ–‡æœ¬åŠ è§£å¯†å·¥å…·ï¼Œä½¿ç”¨Argon2idå’ŒPBKDF2">
  <title>åŠ å¯†é”CryptoLock - æœ¬åœ°å®‰å…¨åŠ å¯†å·¥å…·</title>
  <style>
    :root {
      --bg: #f6f8fb; --card: #fff; --accent: #2563eb; --accent-hover: #1d4ed8; --secondary: #0ea5e9;
      --ok: #16a34a; --danger: #dc2626; --warning: #f59e0b; --muted: #6b7280; --border: #e6eef8; 
      --text: #0f172a; --radius: 12px; --shadow: 0 8px 30px rgba(2, 6, 23, 0.08); --transition: all 0.2s ease;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f172a; --card: #1e293b; --accent: #3b82f6; --accent-hover: #2563eb; --secondary: #38bdf8;
        --ok: #22c55e; --danger: #ef4444; --warning: #f59e0b; --muted: #94a3b8; --border: #334155; --text: #f1f5f9;
      }
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; padding: 20px; }
    .wrap { max-width: 1000px; margin: 0 auto; background: var(--card); padding: 28px; 
      border-radius: var(--radius); box-shadow: var(--shadow); }
    header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 2px solid var(--border); }
    .header-icon { width: 28px; height: 28px; fill: var(--accent); }
    h1 { font-size: 1.5rem; margin: 0; color: var(--text); display: flex; align-items: center; gap: 10px; }
    .description { color: var(--muted); margin-bottom: 24px; font-size: 0.95rem; line-height: 1.7; }
    .section { margin-bottom: 28px; }
    .section-title { font-size: 1.1rem; margin-bottom: 12px; color: var(--text); font-weight: 600; 
      display: flex; align-items: center; gap: 8px; }
    .section-title svg { width: 18px; height: 18px; fill: var(--accent); }
    label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.95rem; color: var(--text); }
    textarea, input[type="password"], input[type="text"], select { width: 100%; padding: 14px;
      border-radius: 8px; border: 2px solid var(--border); background: var(--card); color: var(--text);
      font-family: inherit; font-size: 0.95rem; transition: var(--transition); resize: vertical; }
    textarea:focus, input:focus, select:focus { outline: none; border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
    textarea:hover, input:hover, select:hover { border-color: var(--accent); }
    input[type="checkbox"] { width: auto; margin-right: 8px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .card { background: var(--bg); padding: 20px; border-radius: 10px; border: 1px solid var(--border); }
    .row { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px; }
    button { background: var(--accent); color: white; border: none; padding: 14px 20px; border-radius: 8px;
      cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: var(--transition);
      display: inline-flex; align-items: center; gap: 8px; min-height: 48px; }
    button:hover:not(:disabled) { background: var(--accent-hover); transform: translateY(-1px); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    button.secondary { background: transparent; color: var(--accent); border: 2px solid var(--border); }
    button.secondary:hover:not(:disabled) { background: rgba(37, 99, 235, 0.1); border-color: var(--accent); }
    button.verify-btn {
  background: linear-gradient(135deg, #0ea5e9, #3b82f6);
  color: white;
  border: none;
  box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
}

button.verify-btn:hover:not(:disabled) {
  background: linear-gradient(135deg, #0284c7, #2563eb);
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(14, 165, 233, 0.4);
}

button.verify-btn:active {
  transform: translateY(0);
}
    .status { padding: 12px; border-radius: 8px; margin: 8px 0; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
    .status.ok { background: rgba(22, 163, 74, 0.1); color: var(--ok); border-left: 4px solid var(--ok); }
    .status.info { background: rgba(14, 165, 233, 0.1); color: var(--secondary); border-left: 4px solid var(--secondary); }
    .status.warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); border-left: 4px solid var(--warning); }
    .status.error { background: rgba(220, 38, 38, 0.1); color: var(--danger); border-left: 4px solid var(--danger); }
    .kdf-info { font-size: 0.85rem; color: var(--muted); margin-top: 6px; line-height: 1.5; }
    .password-group { display: flex; gap: 12px; align-items: center; }
    .password-group input { flex: 1; }
    .toggle-password { background: transparent; border: none; color: var(--muted); padding: 10px; cursor: pointer; min-height: auto; }
    .toggle-password:hover { color: var(--text); background: var(--border); }
    .strength-meter { height: 4px; background: var(--border); border-radius: 2px; margin-top: 8px; overflow: hidden; }
    .strength-bar { height: 100%; width: 0%; transition: var(--transition); }
    .strength-text { font-size: 0.8rem; margin-top: 4px; color: var(--muted); }
    .output-container { position: relative; }
    .output-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; }
    .output-btn { background: rgba(255, 255, 255, 0.9); border: 1px solid var(--border); border-radius: 4px;
      padding: 6px 10px; font-size: 0.8rem; color: var(--text); cursor: pointer; }
    .output-btn:hover { background: var(--accent); color: white; }
    .tips { background: linear-gradient(135deg, rgba(14, 165, 233, 0.1), rgba(37, 99, 235, 0.05));
      padding: 20px; border-radius: 10px; margin-top: 24px; }
    .tips h3 { margin: 0 0 12px; color: var(--accent); font-size: 1.1rem; }
    .tips ul { padding-left: 20px; }
    .tips li { margin-bottom: 8px; color: var(--text); }
    .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border);
      border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    .action-buttons { display: flex; flex-wrap: wrap; gap: 12px; margin: 20px 0; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @media (max-width: 768px) {
      .wrap { padding: 16px; }
      .grid { grid-template-columns: 1fr; }
      .row, .action-buttons { flex-direction: column; }
      button { width: 100%; justify-content: center; }
      .password-group { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <header>
      <svg class="header-icon" viewBox="0 0 24 24">
        <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
      </svg>
      <h1>åŠ å¯†é”CryptoLock - æœ¬åœ°å®‰å…¨åŠ å¯†å·¥å…·</h1>
    </header>
    
    <p class="description">
      ä¼˜å…ˆä½¿ç”¨Argon2ï¼ˆæ›´å®‰å…¨ï¼‰æˆ–å›é€€åˆ°PBKDF2ã€‚æ”¯æŒä¸€æ¬¡æ€§è§£å¯†ï¼ˆé˜²å›å­æ¨¡å¼ï¼‰ã€‚å»ºè®®ä¸‹è½½æ•´å¥—æ–‡ä»¶ç¦»çº¿ä½¿ç”¨ã€‚
    </p>
    
    <section class="section">
      <h2 class="section-title">
        <svg viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
        åŠ å¯†è®¾ç½®
      </h2>
      
      <div class="grid">
        <div class="card">
          <label for="argonPreset">KDF ç®—æ³•ä¸é¢„è®¾</label>
          <select id="argonPreset">
            <option value="INTERACTIVE">Interactive (æœ€å¿«)</option>
            <option value="MODERATE" selected>Moderate (æ¨è)</option>
            <option value="SENSITIVE">Sensitive (æ›´å®‰å…¨)</option>
          </select>
          <div class="kdf-info">
            <span id="kdfStatus">æ£€æµ‹ä¸­...</span>
            <div style="margin-top: 8px;">
              <button id="loadSodiumBtn" class="secondary" style="padding: 8px 12px; font-size: 0.85rem;">åŠ è½½ libsodium</button>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="section-title">ç®—æ³•ä¿¡æ¯</div>
          <div class="kdf-info">
            <p><strong>Argon2id</strong>: å†…å­˜å›°éš¾å¯†ç å“ˆå¸Œå‡½æ•°</p>
            <p><strong>PBKDF2</strong>: SHA-256å¯†é’¥æ´¾ç”Ÿï¼Œ200,000æ¬¡è¿­ä»£</p>
            <p><strong>AES-GCM</strong>: è®¤è¯åŠ å¯†ï¼Œ256ä½å¯†é’¥</p>
          </div>
          <div class="status info" id="algorithmInfo">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            ä½¿ç”¨ç°ä»£åŠ å¯†æ ‡å‡†
          </div>
        </div>
        
        <div class="card">
          <div class="section-title">
            <svg viewBox="0 0 24 24"><path d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
            ä¸€æ¬¡æ€§è§£å¯†ï¼ˆå¯é€‰ï¼‰
          </div>
          <div class="row" style="align-items: center; margin-bottom: 12px;">
            <input type="checkbox" id="enableOneTime" style="width: auto; margin: 0;">
            <label for="enableOneTime" style="display: inline; margin: 0; margin-left: 8px;">å¯ç”¨ä¸€æ¬¡æ€§è§£å¯†ï¼ˆé˜²å›å­æ¨¡å¼ï¼‰</label>
          </div>
          <div id="oneTimeSettings" style="display: none;">
            <div class="kdf-info" style="margin-top: 12px;">
              <p><strong>âš ï¸ æ³¨æ„ï¼š</strong>æ­¤åŠŸèƒ½å¹¶éç»å¯¹å®‰å…¨ï¼</p>
              <ul style="padding-left: 20px; margin-top: 4px; font-size: 0.9rem;">
                <li>åŒä¸€æµè§ˆå™¨ä¸­ï¼Œå¯†æ–‡åªèƒ½è§£å¯†ä¸€æ¬¡</li>
                <li>æ¸…é™¤æµè§ˆå™¨æ•°æ®å¯é‡ç½®</li>
                <li>é€‚ç”¨äºéå¯¹æŠ—ç¯å¢ƒ</li>
              </ul>
            </div>
            <div class="row" style="margin-top: 12px;">
              <button id="clearRecordsBtn" class="secondary" style="width: auto; padding: 8px 12px;">æ¸…é™¤è®°å½•</button>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <section class="section">
      <h2 class="section-title">
        <svg viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
        è¾“å…¥æ–‡æœ¬ä¸å£ä»¤
      </h2>
      
      <div class="grid">
        <div class="card">
          <label for="plaintext">è¦åŠ å¯†çš„æ–‡æœ¬</label>
          <textarea id="plaintext" rows="6" placeholder="åœ¨æ­¤è¾“å…¥è¦åŠ å¯†çš„æ–‡æœ¬..."></textarea>
          <div class="row">
            <button id="clearTextBtn" class="secondary">æ¸…ç©º</button>
            <button id="sampleTextBtn" class="secondary">ç¤ºä¾‹æ–‡æœ¬</button>
          </div>
        </div>
        
        <div class="card">
          <label for="password">å£ä»¤</label>
          <div class="password-group">
            <input id="password" type="password" placeholder="è¾“å…¥åŠ å¯†å£ä»¤...">
            <button id="togglePassword" class="toggle-password" title="æ˜¾ç¤º/éšè—å£ä»¤">ğŸ‘ï¸</button>
          </div>
          
          <div class="strength-meter"><div id="strengthBar" class="strength-bar"></div></div>
          <div id="strengthText" class="strength-text">å£ä»¤å¼ºåº¦</div>
          
          <div class="row" style="margin-top: 16px;">
            <button id="genBtn" class="secondary">ç”Ÿæˆå£ä»¤</button>
            <button id="copyPassBtn" class="secondary">å¤åˆ¶å£ä»¤</button>
          </div>
        </div>
      </div>
    </section>
    
    <section class="section">
      <h2 class="section-title">
        <svg viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        æ“ä½œ
      </h2>
      
      <div class="action-buttons">
        <button id="encryptBtn">åŠ å¯†æ–‡æœ¬</button>
        <button id="decryptBtn" class="secondary">è§£å¯†æ–‡æœ¬</button>
        <button id="copyBtn" class="secondary">å¤åˆ¶è¾“å‡º</button>
        <button id="downloadBtn" class="secondary">ä¸‹è½½å¯†æ–‡</button>
        <a href="verify.html" style="text-decoration: none;"><button class="secondary">æ–‡ä»¶æ ¡éªŒ</button></a>
        <a href="verify.html" style="text-decoration: none;"><button class="verify-btn">æ–‡ä»¶æ ¡éªŒ</button></a>
      </div>
    </section>
    
    <section class="section">
      <h2 class="section-title">
        <svg viewBox="0 0 24 24"><path d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
        è¾“å‡ºç»“æœ
      </h2>
      
      <div class="output-container">
        <label for="output">åŠ å¯†è¾“å‡ºï¼ˆBase64 JSONæ ¼å¼ï¼‰</label>
        <textarea id="output" rows="6" placeholder="åŠ å¯†æˆ–è§£å¯†çš„ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
        <div class="output-actions">
          <button class="output-btn" id="formatOutputBtn">æ ¼å¼åŒ–</button>
          <button class="output-btn" id="copyBtn2">å¤åˆ¶</button>
        </div>
      </div>
      
      <div class="row" style="margin-top: 12px;">
        <button id="clearOutputBtn" class="secondary">æ¸…ç©ºè¾“å‡º</button>
        <div id="operationStatus" class="status" style="flex: 1; display: none;"></div>
      </div>
    </section>
    
    <div class="tips">
      <h3>å®‰å…¨ä½¿ç”¨å»ºè®®</h3>
      <ul>
        <li>ğŸ”’ ç¦»çº¿ä½¿ç”¨æ—¶æ‰“åŒ…æ•´å¥—æ–‡ä»¶</li>
        <li>âš ï¸ ä¸€æ¬¡æ€§è§£å¯†ä»…ä¸º"é˜²å›å­"æ¨¡å¼</li>
        <li>ğŸ”‘ å£ä»¤è‡³å°‘12ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦</li>
        <li>ğŸ“± é€šè¿‡ä¸åŒæ¸ é“ä¼ è¾“å¯†æ–‡å’Œå£ä»¤</li>
      </ul>
    </div>
  </main>

  <script>
    // é…ç½®
    const CONFIG = {
      PBKDF2_ITERATIONS: 200000,
      DEFAULT_PRESET: 'MODERATE',
      SALT_LENGTHS: { ARGON2: 16, PBKDF2: 16 },
      ONE_TIME_STORAGE_KEY: 'cryptolock_one_time_ids'
    };

    // å·¥å…·å‡½æ•°
    const utils = {
      encoder: new TextEncoder(),
      decoder: new TextDecoder(),
      
      randomBytes(length) {
        const bytes = new Uint8Array(length);
        crypto.getRandomValues(bytes);
        return bytes;
      },
      
      arrayBufferToBase64(buffer) {
        const bytes = new Uint8Array(buffer);
        return btoa(String.fromCharCode(...bytes));
      },
      
      base64ToArrayBuffer(base64) {
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
        return bytes.buffer;
      },
      
      calculatePasswordStrength(password) {
        if (!password) return { score: 0, text: 'æœªè¾“å…¥' };
        let score = 0;
        const length = password.length;
        if (length >= 8) score += 1;
        if (length >= 12) score += 1;
        if (length >= 16) score += 1;
        if (/[a-z]/.test(password)) score += 1;
        if (/[A-Z]/.test(password)) score += 1;
        if (/[0-9]/.test(password)) score += 1;
        if (/[^a-zA-Z0-9]/.test(password)) score += 1;
        const percentage = Math.min(100, Math.round((score / 8) * 100));
        let text, color;
        if (percentage < 30) { text = 'å¼±'; color = '#dc2626'; }
        else if (percentage < 60) { text = 'ä¸€èˆ¬'; color = '#f59e0b'; }
        else if (percentage < 80) { text = 'è‰¯å¥½'; color = '#16a34a'; }
        else { text = 'å¼º'; color = '#059669'; }
        return { score: percentage, text: `${text} (${percentage}%)`, color };
      },
      
      showStatus(message, type = 'info', duration = 3000) {
        const statusEl = document.getElementById('operationStatus');
        statusEl.innerHTML = message;
        statusEl.className = `status ${type}`;
        statusEl.style.display = 'flex';
        if (duration > 0) setTimeout(() => statusEl.style.display = 'none', duration);
      },
      
      generateOneTimeId() {
        return utils.arrayBufferToBase64(crypto.getRandomValues(new Uint8Array(16)));
      },
      
      getDecryptedIds() {
        try {
          const stored = localStorage.getItem(CONFIG.ONE_TIME_STORAGE_KEY);
          return stored ? JSON.parse(stored) : [];
        } catch { return []; }
      },
      
      addDecryptedId(id) {
        const ids = utils.getDecryptedIds();
        if (!ids.includes(id)) {
          ids.push(id);
          localStorage.setItem(CONFIG.ONE_TIME_STORAGE_KEY, JSON.stringify(ids));
        }
      },
      
      isIdDecrypted(id) {
        return utils.getDecryptedIds().includes(id);
      },
      
      clearDecryptedIds() {
        localStorage.removeItem(CONFIG.ONE_TIME_STORAGE_KEY);
      }
    };

    // æ ¸å¿ƒå˜é‡
    let sodiumReady = false;
    let sodium = null;

    // æ›´æ–°KDFçŠ¶æ€
    function updateKdfStatus() {
      const statusEl = document.getElementById('kdfStatus');
      if (sodiumReady) {
        statusEl.innerHTML = '<strong>âœ… Argon2id å¯ç”¨</strong>';
        statusEl.className = 'status ok';
      } else {
        statusEl.innerHTML = '<strong>âš ï¸ ä½¿ç”¨ PBKDF2 å›é€€</strong>';
        statusEl.className = 'status warning';
      }
    }

    // æ£€æµ‹sodium
    async function detectSodium() {
      if (window.sodium) {
        sodium = window.sodium;
        try {
          await sodium.ready;
          sodiumReady = true;
        } catch { sodiumReady = false; }
      }
      updateKdfStatus();
    }

    // å¯†é’¥æ´¾ç”Ÿ
    async function deriveKey(password, salt, preset = CONFIG.DEFAULT_PRESET) {
      if (sodiumReady) {
        let opsLimit, memLimit;
        if (preset === 'INTERACTIVE') {
          opsLimit = sodium.crypto_pwhash_OPSLIMIT_INTERACTIVE;
          memLimit = sodium.crypto_pwhash_MEMLIMIT_INTERACTIVE;
        } else if (preset === 'SENSITIVE') {
          opsLimit = sodium.crypto_pwhash_OPSLIMIT_SENSITIVE;
          memLimit = sodium.crypto_pwhash_MEMLIMIT_SENSITIVE;
        } else {
          opsLimit = sodium.crypto_pwhash_OPSLIMIT_MODERATE;
          memLimit = sodium.crypto_pwhash_MEMLIMIT_MODERATE;
        }
        const saltBytes = salt instanceof Uint8Array ? salt : new Uint8Array(salt);
        const keyBytes = sodium.crypto_pwhash(32, password, saltBytes, opsLimit, memLimit, sodium.crypto_pwhash_ALG_ARGON2ID13);
        return crypto.subtle.importKey('raw', sodium.to_array_buffer(keyBytes), 
          { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']);
      } else {
        const passwordKey = await crypto.subtle.importKey('raw', utils.encoder.encode(password), 
          { name: 'PBKDF2' }, false, ['deriveKey']);
        return crypto.subtle.deriveKey(
          { name: 'PBKDF2', salt: salt.buffer || salt, iterations: CONFIG.PBKDF2_ITERATIONS, hash: 'SHA-256' },
          passwordKey, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']);
      }
    }

    // åŠ å¯†
    async function encryptText(plaintext, password) {
      const startTime = performance.now();
      const useOneTime = document.getElementById('enableOneTime').checked;
      const oneTimeId = useOneTime ? utils.generateOneTimeId() : null;
      
      const saltLength = sodiumReady ? CONFIG.SALT_LENGTHS.ARGON2 : CONFIG.SALT_LENGTHS.PBKDF2;
      const salt = utils.randomBytes(saltLength);
      const iv = utils.randomBytes(12);
      const preset = document.getElementById('argonPreset').value;
      const key = await deriveKey(password, salt, preset);
      
      const ciphertext = await crypto.subtle.encrypt({ name: 'AES-GCM', iv: iv }, key, utils.encoder.encode(plaintext));
      
      const payload = {
        version: 2, timestamp: new Date().toISOString(), algorithm: 'AES-GCM-256',
        kdf: sodiumReady ? 'argon2id' : 'pbkdf2', preset: sodiumReady ? preset : undefined,
        salt: utils.arrayBufferToBase64(salt), iv: utils.arrayBufferToBase64(iv),
        ciphertext: utils.arrayBufferToBase64(ciphertext), oneTimeId: oneTimeId
      };
      
      return {
        payload: btoa(JSON.stringify(payload)),
        duration: performance.now() - startTime,
        usedOneTime: !!oneTimeId
      };
    }

    // è§£å¯†
    async function decryptText(encryptedData, password) {
      const startTime = performance.now();
      let payload;
      try { payload = JSON.parse(atob(encryptedData)); } catch { throw new Error('å¯†æ–‡æ ¼å¼é”™è¯¯'); }
      if (!payload.salt || !payload.iv || !payload.ciphertext) throw new Error('å¯†æ–‡ç¼ºå°‘å¿…è¦å­—æ®µ');
      if (payload.oneTimeId && utils.isIdDecrypted(payload.oneTimeId)) throw new Error('æ­¤å¯†æ–‡å·²è¢«è§£å¯†è¿‡');
      
      const salt = new Uint8Array(utils.base64ToArrayBuffer(payload.salt));
      const iv = new Uint8Array(utils.base64ToArrayBuffer(payload.iv));
      const ciphertext = utils.base64ToArrayBuffer(payload.ciphertext);
      const preset = payload.preset || document.getElementById('argonPreset').value;
      const key = await deriveKey(password, salt, preset);
      
      const plaintextBuffer = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: iv }, key, ciphertext);
      if (payload.oneTimeId) utils.addDecryptedId(payload.oneTimeId);
      
      return {
        text: utils.decoder.decode(plaintextBuffer),
        duration: performance.now() - startTime,
        usedOneTime: !!payload.oneTimeId
      };
    }

    // äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
      // åŠ å¯†æŒ‰é’®
      document.getElementById('encryptBtn').addEventListener('click', async () => {
        const plaintext = document.getElementById('plaintext').value.trim();
        const password = document.getElementById('password').value.trim();
        if (!plaintext) return utils.showStatus('è¯·è¾“å…¥è¦åŠ å¯†çš„æ–‡æœ¬', 'warning');
        if (!password) return utils.showStatus('è¯·è¾“å…¥åŠ å¯†å£ä»¤', 'warning');
        
        const btn = document.getElementById('encryptBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> åŠ å¯†ä¸­...';
        
        try {
          const { payload, duration, usedOneTime } = await encryptText(plaintext, password);
          document.getElementById('output').value = payload;
          utils.showStatus(`âœ… åŠ å¯†å®Œæˆ (${duration.toFixed(0)}ms)` + (usedOneTime ? 'ï¼Œå·²å¯ç”¨ä¸€æ¬¡æ€§è§£å¯†' : ''), 'ok');
        } catch (error) {
          console.error('åŠ å¯†å¤±è´¥:', error);
          utils.showStatus(`åŠ å¯†å¤±è´¥: ${error.message}`, 'error');
        } finally {
          btn.disabled = false;
          btn.innerHTML = 'åŠ å¯†æ–‡æœ¬';
        }
      });
      
      // è§£å¯†æŒ‰é’®
      document.getElementById('decryptBtn').addEventListener('click', async () => {
        const encryptedData = document.getElementById('output').value.trim();
        const password = document.getElementById('password').value.trim();
        if (!encryptedData) return utils.showStatus('è¯·è¾“å…¥è¦è§£å¯†çš„å¯†æ–‡', 'warning');
        if (!password) return utils.showStatus('è¯·è¾“å…¥è§£å¯†å£ä»¤', 'warning');
        
        const btn = document.getElementById('decryptBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> è§£å¯†ä¸­...';
        
        try {
          const { text, duration, usedOneTime } = await decryptText(encryptedData, password);
          document.getElementById('plaintext').value = text;
          utils.showStatus(`âœ… è§£å¯†å®Œæˆ (${duration.toFixed(0)}ms)` + (usedOneTime ? 'ï¼Œå·²æ ‡è®°ä¸ºå·²è§£å¯†' : ''), 'ok');
        } catch (error) {
          console.error('è§£å¯†å¤±è´¥:', error);
          utils.showStatus(`è§£å¯†å¤±è´¥: ${error.message}`, 'error');
        } finally {
          btn.disabled = false;
          btn.innerHTML = 'è§£å¯†æ–‡æœ¬';
        }
      });
      
      // å…¶ä»–æŒ‰é’®
      document.getElementById('genBtn').addEventListener('click', () => {
        const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
        const randomValues = new Uint8Array(20);
        crypto.getRandomValues(randomValues);
        let password = '';
        for (let i = 0; i < 20; i++) password += charset[randomValues[i] % charset.length];
        document.getElementById('password').value = password;
        updatePasswordStrength();
        utils.showStatus('âœ… å·²ç”Ÿæˆéšæœºå£ä»¤', 'ok');
      });
      
      document.getElementById('copyPassBtn').addEventListener('click', async () => {
        const password = document.getElementById('password').value;
        if (!password) return utils.showStatus('æ²¡æœ‰å£ä»¤å¯å¤åˆ¶', 'warning');
        try {
          await navigator.clipboard.writeText(password);
          utils.showStatus('âœ… å£ä»¤å·²å¤åˆ¶', 'ok');
        } catch { utils.showStatus('å¤åˆ¶å¤±è´¥', 'error'); }
      });
      
      document.getElementById('copyBtn').addEventListener('click', async () => {
        const output = document.getElementById('output').value;
        if (!output) return utils.showStatus('æ²¡æœ‰è¾“å‡ºå¯å¤åˆ¶', 'warning');
        try {
          await navigator.clipboard.writeText(output);
          utils.showStatus('âœ… è¾“å‡ºå·²å¤åˆ¶', 'ok');
        } catch { utils.showStatus('å¤åˆ¶å¤±è´¥', 'error'); }
      });
      
      document.getElementById('copyBtn2').addEventListener('click', async () => {
        const output = document.getElementById('output').value;
        if (!output) return utils.showStatus('æ²¡æœ‰è¾“å‡ºå¯å¤åˆ¶', 'warning');
        try {
          await navigator.clipboard.writeText(output);
          utils.showStatus('âœ… è¾“å‡ºå·²å¤åˆ¶', 'ok');
        } catch { utils.showStatus('å¤åˆ¶å¤±è´¥', 'error'); }
      });
      
      document.getElementById('downloadBtn').addEventListener('click', () => {
        const output = document.getElementById('output').value;
        if (!output) return utils.showStatus('æ²¡æœ‰è¾“å‡ºå¯ä¸‹è½½', 'warning');
        const blob = new Blob([output], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `encrypted_${Date.now()}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        utils.showStatus('âœ… è¾“å‡ºå·²ä¸‹è½½', 'ok');
      });
      
      document.getElementById('clearTextBtn').addEventListener('click', () => {
        document.getElementById('plaintext').value = '';
        utils.showStatus('å·²æ¸…ç©ºè¾“å…¥æ–‡æœ¬', 'info');
      });
      
      document.getElementById('clearOutputBtn').addEventListener('click', () => {
        document.getElementById('output').value = '';
        utils.showStatus('å·²æ¸…ç©ºè¾“å‡º', 'info');
      });
      
      document.getElementById('sampleTextBtn').addEventListener('click', () => {
        document.getElementById('plaintext').value = `è¿™æ˜¯ä¸€ä¸ªåŠ å¯†ç¤ºä¾‹æ–‡æœ¬ã€‚\n\nä½¿ç”¨è¯´æ˜ï¼š\n1. è¾“å…¥å¼ºå£ä»¤\n2. ç‚¹å‡»"åŠ å¯†æ–‡æœ¬"\n3. å‘é€å¯†æ–‡\n4. é€šè¿‡å¦ä¸€æ¸ é“å‘ŠçŸ¥å£ä»¤`;
        utils.showStatus('å·²åŠ è½½ç¤ºä¾‹æ–‡æœ¬', 'info');
      });
      
      document.getElementById('togglePassword').addEventListener('click', () => {
        const passInput = document.getElementById('password');
        passInput.type = passInput.type === 'password' ? 'text' : 'password';
      });
      
      document.getElementById('formatOutputBtn').addEventListener('click', () => {
        const output = document.getElementById('output').value;
        if (!output) return utils.showStatus('æ²¡æœ‰è¾“å‡ºå¯æ ¼å¼åŒ–', 'warning');
        try {
          const parsed = JSON.parse(atob(output));
          document.getElementById('output').value = btoa(JSON.stringify(parsed, null, 2));
          utils.showStatus('âœ… è¾“å‡ºå·²æ ¼å¼åŒ–', 'ok');
        } catch { utils.showStatus('æ ¼å¼åŒ–å¤±è´¥', 'error'); }
      });
      
      document.getElementById('loadSodiumBtn').addEventListener('click', async () => {
        const btn = document.getElementById('loadSodiumBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> åŠ è½½ä¸­...';
        try {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/libsodium-wrappers@0.7.10/dist/modules/libsodium-wrappers.min.js';
          await new Promise((resolve, reject) => {
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
          await sodium.ready;
          sodiumReady = true;
          updateKdfStatus();
          utils.showStatus('âœ… libsodium å·²åŠ è½½', 'ok');
        } catch (error) {
          console.error('åŠ è½½libsodiumå¤±è´¥:', error);
          utils.showStatus('âŒ åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨PBKDF2', 'error');
        } finally {
          btn.disabled = false;
          btn.textContent = 'åŠ è½½ libsodium';
        }
      });
      
      document.getElementById('enableOneTime').addEventListener('change', function() {
        document.getElementById('oneTimeSettings').style.display = this.checked ? 'block' : 'none';
        const count = utils.getDecryptedIds().length;
        if (count > 0) utils.showStatus(`å·²è®°å½• ${count} æ¡è§£å¯†è®°å½•`, 'info', 2000);
      });
      
      document.getElementById('clearRecordsBtn').addEventListener('click', () => {
        utils.clearDecryptedIds();
        utils.showStatus('âœ… è§£å¯†è®°å½•å·²æ¸…é™¤', 'ok');
      });
      
      document.getElementById('password').addEventListener('input', updatePasswordStrength);
      
      // é”®ç›˜å¿«æ·é”®
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          if (document.getElementById('plaintext').value && document.getElementById('password').value) {
            e.preventDefault();
            document.getElementById('encryptBtn').click();
          }
        }
      });
    }

    // æ›´æ–°å£ä»¤å¼ºåº¦
    function updatePasswordStrength() {
      const password = document.getElementById('password').value;
      const strength = utils.calculatePasswordStrength(password);
      document.getElementById('strengthBar').style.width = `${strength.score}%`;
      document.getElementById('strengthBar').style.backgroundColor = strength.color;
      document.getElementById('strengthText').textContent = `å£ä»¤å¼ºåº¦: ${strength.text}`;
    }

    // åˆå§‹åŒ–
    async function init() {
      await detectSodium();
      setupEventListeners();
      updatePasswordStrength();
      utils.showStatus('å·¥å…·å·²å‡†å¤‡å°±ç»ª', 'ok', 2000);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
